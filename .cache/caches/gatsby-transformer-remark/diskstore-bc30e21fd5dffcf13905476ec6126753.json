{"expireTime":9007200904828481000,"key":"transformer-remark-markdown-html-ast-0fb84f277036b45164a6de6b2209ad0b--","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Since I work for an IIoT combined hardware/sofware company, we often receive packages through the mail. This includes anything from dev boards to etched plastic enclosures. Now that we receive packages so often, it is not very easy to keep track of when a package is supposed to be arriving, and we don't always get notifications when items get held up in customs or get lost in the process. Once again APIs are here to save the day.","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":434,"offset":434}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":434,"offset":434}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the ideal scenario, we could create a Chrome extension with a trained machine learning algorithm that can detect whether a purchase has been made for a delivery, guess the delivery timeframe, store the delivery in a database, and automatically alert the user if today's date is later than the anticipated delivery date. However, even this scenario doesn't account for company purchases made with a purchase order system, which is why procurement teams exist.","position":{"start":{"line":4,"column":1,"offset":436},"end":{"line":4,"column":462,"offset":897}}}],"position":{"start":{"line":4,"column":1,"offset":436},"end":{"line":4,"column":462,"offset":897}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Given that I am no genius, an idiot's backup to the system above is to use a slack slash command to automatically update a simple database, like a spreadsheet in Google Sheets for example. Then, using an incoming webhook, send an alert if it is past the delivery date for the package, triggered once every day to a channel, perhaps called #deliveryalerts. If there are no packages that are supposed to be delivered already, no alerts. ","position":{"start":{"line":6,"column":1,"offset":899},"end":{"line":6,"column":436,"offset":1334}}}],"position":{"start":{"line":6,"column":1,"offset":899},"end":{"line":6,"column":436,"offset":1334}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can first create a simple spreadsheet database like this:\n","position":{"start":{"line":8,"column":1,"offset":1336},"end":{"line":9,"column":1,"offset":1398}}},{"type":"element","tagName":"img","properties":{"src":"https://raw.githubusercontent.com/simjxu/simjxu.github.io/gh-pages/img/vendor_spreadsheet.jpg","alt":"vendor-spreadsheet"},"children":[],"position":{"start":{"line":9,"column":1,"offset":1398},"end":{"line":9,"column":117,"offset":1514}}},{"type":"text","value":"\nThis would show the item that is being delivered, the estimated delivery date, and a boolean Yes/No as to whether the item has been received.","position":{"start":{"line":9,"column":117,"offset":1514},"end":{"line":10,"column":142,"offset":1656}}}],"position":{"start":{"line":8,"column":1,"offset":1336},"end":{"line":10,"column":142,"offset":1656}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then, we can create the #deliveryalerts channel in Slack, and integrate a Slack incoming webhook that points to #deliveryalerts and a slash command. In this case, we create one called /delivery. /delivery will send a post request to some endpoint that you need to define (a url). In our case, we can just use Google Apps script to set up this endpoint. Anything written after the /delivery command will be sent to the endpoint, and we can create the script to parse this text message using regular expressions (regex). Google Apps Script will handle the request through a ","position":{"start":{"line":12,"column":1,"offset":1658},"end":{"line":12,"column":573,"offset":2230}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"doPost()"}],"position":{"start":{"line":12,"column":573,"offset":2230},"end":{"line":12,"column":583,"offset":2240}}},{"type":"text","value":" function that you must write. Just take the spreadsheet that you want to set as your deliveries database, and on the Tools menu select script editor. Copy the ","position":{"start":{"line":12,"column":583,"offset":2240},"end":{"line":12,"column":743,"offset":2400}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"doPost()"}],"position":{"start":{"line":12,"column":743,"offset":2400},"end":{"line":12,"column":753,"offset":2410}}},{"type":"text","value":" example below into the Code.gs file.","position":{"start":{"line":12,"column":753,"offset":2410},"end":{"line":12,"column":790,"offset":2447}}}],"position":{"start":{"line":12,"column":1,"offset":1658},"end":{"line":12,"column":790,"offset":2447}}},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"// Handle the Post request, based upon the command that is written after the slash command\nfunction doPost(e){\n  var commandReceived = e.parameter[\"text\"];\n\n  if (commandReceived.match(/help/)) showHelp();            // showHelp() is run when slack user types: /delivery help\n  if (commandReceived.match(/list/)) listDeliveries();\n  if (commandReceived.match(/add/)) add(e);\n  if (commandReceived.match(/remove/)) remove(e);           // remove(e) is run after slack user types: /delivery remove someItem\n  if (commandReceived.match(/received/)) received(e);\n  \n  // Need to create a return, otherwise slack will complain that there was no response created\n  var returnMessage = \"send complete\";\n  return ContentService.createTextOutput(JSON.stringify({text:returnMessage})).setMimeType(ContentService.MimeType.JSON);\n}\n"}],"position":{"start":{"line":14,"column":1,"offset":2449},"end":{"line":29,"column":4,"offset":3269}}}],"position":{"start":{"line":14,"column":1,"offset":2449},"end":{"line":29,"column":4,"offset":3269}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Slack complains if there is no return message, so I've also included just a simple \"send complete\" at the end of the ","position":{"start":{"line":31,"column":1,"offset":3271},"end":{"line":31,"column":118,"offset":3388}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"doPost()"}],"position":{"start":{"line":31,"column":118,"offset":3388},"end":{"line":31,"column":128,"offset":3398}}},{"type":"text","value":" function. Now, all you need to do is create the functions to handle each of the if statements in ","position":{"start":{"line":31,"column":128,"offset":3398},"end":{"line":31,"column":226,"offset":3496}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"doPost()"}],"position":{"start":{"line":31,"column":226,"offset":3496},"end":{"line":31,"column":236,"offset":3506}}},{"type":"text","value":". An example of this function can be seen here, for marking a delivery as received. Notice that regular expressions are used to determine the format for the string that is attached to the slash command.","position":{"start":{"line":31,"column":236,"offset":3506},"end":{"line":31,"column":438,"offset":3708}}}],"position":{"start":{"line":31,"column":1,"offset":3271},"end":{"line":31,"column":438,"offset":3708}}},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"function received(e){\n  var receiver = e.parameter[\"user_name\"];\n  var messageReceived = e.parameter[\"text\"].trim();\n  var regex = /received ([a-zA-Z0-9-_\\s]+)/;\n  var matches = regex.exec(messageReceived);\n  var deliveryName = matches[1];\n  var sheet = getStatusSheet();\n  var affectedRow = getDeliveryRow(deliveryName);\n  \n  if (affectedRow) {\n    sheet.getRange(\"D\" + (affectedRow)).setValue('Y');\n    getLogger().log(\"%s received delivery %s\", receiver, deliveryName);\n    listDeliveries();\n  } else {\n    sendMessage(\"*\" + deliveryName + \"* delivery not found\");\n  }\n}\n"}],"position":{"start":{"line":33,"column":1,"offset":3710},"end":{"line":51,"column":4,"offset":4302}}}],"position":{"start":{"line":33,"column":1,"offset":3710},"end":{"line":51,"column":4,"offset":4302}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then there's the timed triggers. To do this, I used a trigger function, which runs another function I made, querySpreadsheet, once every day. I also created a button on a html page to turn on/off this trigger.","position":{"start":{"line":53,"column":1,"offset":4304},"end":{"line":53,"column":210,"offset":4513}}}],"position":{"start":{"line":53,"column":1,"offset":4304},"end":{"line":53,"column":210,"offset":4513}}},{"type":"text","value":"\n"},{"type":"element","tagName":"pre","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"function createTrigger() {\n  ScriptApp.newTrigger('querySpreadsheet')\n  .timeBased()\n  .everyDays(1)\n  .create()\n}\n"}],"position":{"start":{"line":54,"column":1,"offset":4514},"end":{"line":61,"column":4,"offset":4647}}}],"position":{"start":{"line":54,"column":1,"offset":4514},"end":{"line":61,"column":4,"offset":4647}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Another note, I used BetterLog to create another spreadsheet tab that keeps track of the different actions users take with the app. This helps us know who received what package in case we need to track one down. You'll have to add the BetterLog library to your project.","position":{"start":{"line":63,"column":1,"offset":4649},"end":{"line":63,"column":270,"offset":4918}}}],"position":{"start":{"line":63,"column":1,"offset":4649},"end":{"line":63,"column":270,"offset":4918}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To set everything up on the Slack end, login to ","position":{"start":{"line":65,"column":1,"offset":4920},"end":{"line":65,"column":49,"offset":4968}}},{"type":"raw","value":"<a href=\"https://api.slack.com/apps\">","position":{"start":{"line":65,"column":49,"offset":4968},"end":{"line":65,"column":86,"offset":5005}}},{"type":"text","value":"api.slack.com/apps","position":{"start":{"line":65,"column":86,"offset":5005},"end":{"line":65,"column":104,"offset":5023}}},{"type":"raw","value":"</a>","position":{"start":{"line":65,"column":104,"offset":5023},"end":{"line":65,"column":108,"offset":5027}}},{"type":"text","value":", create a new app, and Add features and functionality, adding Incoming Webhooks, Interactive Components, and Slash Commands. You will need to copy the incoming webhooks link into the Google Apps Script. ","position":{"start":{"line":65,"column":108,"offset":5027},"end":{"line":65,"column":312,"offset":5231}}}],"position":{"start":{"line":65,"column":1,"offset":4920},"end":{"line":65,"column":312,"offset":5231}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The full script is located in this github repository: ","position":{"start":{"line":67,"column":1,"offset":5233},"end":{"line":67,"column":55,"offset":5287}}},{"type":"raw","value":"<a href=\"https://github.com/simjxu/google_apps_scripts/tree/master/Slack-Delivery-Tracking\">","position":{"start":{"line":67,"column":55,"offset":5287},"end":{"line":67,"column":147,"offset":5379}}},{"type":"text","value":"Slack Delivery Tracking","position":{"start":{"line":67,"column":147,"offset":5379},"end":{"line":67,"column":170,"offset":5402}}},{"type":"raw","value":"</a>","position":{"start":{"line":67,"column":170,"offset":5402},"end":{"line":67,"column":174,"offset":5406}}},{"type":"text","value":"  Be sure to change out the spreadsheet id to match the spreadsheet id of your Google sheets document (the long string in your Google Sheet URL), and change the incoming webhook link to the webhook link that you receive when you enable that feature on your slack apps. You might want to test by changing the ","position":{"start":{"line":67,"column":174,"offset":5406},"end":{"line":67,"column":482,"offset":5714}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createTrigger()"}],"position":{"start":{"line":67,"column":482,"offset":5714},"end":{"line":67,"column":499,"offset":5731}}},{"type":"text","value":" function to be ","position":{"start":{"line":67,"column":499,"offset":5731},"end":{"line":67,"column":515,"offset":5747}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".everyMinutes(1)"}],"position":{"start":{"line":67,"column":515,"offset":5747},"end":{"line":67,"column":533,"offset":5765}}},{"type":"text","value":" instead of ","position":{"start":{"line":67,"column":533,"offset":5765},"end":{"line":67,"column":545,"offset":5777}}},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":".everyDays(1)"}],"position":{"start":{"line":67,"column":545,"offset":5777},"end":{"line":67,"column":560,"offset":5792}}},{"type":"text","value":".","position":{"start":{"line":67,"column":560,"offset":5792},"end":{"line":67,"column":561,"offset":5793}}}],"position":{"start":{"line":67,"column":1,"offset":5233},"end":{"line":67,"column":561,"offset":5793}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To Do: to reduce time that it takes to read through the excel sheet, it's best to add within the trigger function something that places the received packages into some sort of archive spreadsheet tab. But alas, I already took too long to create this post. I can't take this long if I want to see rows of green squares on my github.","position":{"start":{"line":69,"column":1,"offset":5795},"end":{"line":69,"column":332,"offset":6126}}}],"position":{"start":{"line":69,"column":1,"offset":5795},"end":{"line":69,"column":332,"offset":6126}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Useful references: ","position":{"start":{"line":71,"column":1,"offset":6128},"end":{"line":71,"column":20,"offset":6147}}},{"type":"element","tagName":"a","properties":{"href":"https://medium.com/@hopsor/building-a-slack-serverless-bot-with-google-apps-script-and-spreadsheets-35bdac755a44"},"children":[{"type":"text","value":"https://medium.com/@hopsor/building-a-slack-serverless-bot-with-google-apps-script-and-spreadsheets-35bdac755a44","position":{"start":{"line":71,"column":20,"offset":6147},"end":{"line":71,"column":132,"offset":6259}}}],"position":{"start":{"line":71,"column":20,"offset":6147},"end":{"line":71,"column":132,"offset":6259}}}],"position":{"start":{"line":71,"column":1,"offset":6128},"end":{"line":71,"column":132,"offset":6259}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":72,"column":1,"offset":6260}}}}